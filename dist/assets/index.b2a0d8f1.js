import{l as t,h as i,m as s,D as e,Z as h,k as o,u as a}from"./vendor.74ed7ee8.js";!function(t=".",i="__import__"){try{self[i]=new Function("u","return import(u)")}catch(s){const e=new URL(t,location),h=t=>{URL.revokeObjectURL(t.src),t.remove()};self[i]=t=>new Promise(((s,o)=>{const a=new URL(t,e);if(self[i].moduleMap[a])return s(self[i].moduleMap[a]);const r=new Blob([`import * as m from '${a}';`,`${i}.moduleMap['${a}']=m;`],{type:"text/javascript"}),n=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(r),onerror(){o(new Error(`Failed to import: ${t}`)),h(n)},onload(){s(self[i].moduleMap[a]),h(n)}});document.head.appendChild(n)})),self[i].moduleMap={}}}("/assets/");class r{constructor(t,i){this.rows=i,this.cols=t,this.cells=[],this.createCells(),this.defineNeighboors()}createCells(){for(let t=0;t<this.cols;t++)for(let i=0;i<this.rows;i++)this.cells.push(new n(i,t))}getCell(t,i){let s=this.cells.filter((s=>s.x===t&&s.y===i));if(0!==s.length)return s[0];console.error(`La cellule (x: ${t}, y: ${i}) n'existe pas`)}updateCell(t){this.cells.includes(t)&&(console.log(t),this.defineNeighboors(),this.cells[this.cells.indexOf(t)]=t)}defineNeighboors(){this.cells.forEach((t=>{t.neighboor.top=t.y>=1?this.cells.filter((i=>i.x<=t.x&&i.x+i.width>t.x&&i.y===t.y-t.height))[0]:null,t.neighboor.bottom=t.y<=this.rows-1?this.cells.filter((i=>i.x<=t.x&&i.x+i.width>t.x&&i.y===t.y+t.height))[0]:null,t.neighboor.left=t.x>=1?this.cells.filter((i=>i.y<=t.y&&i.y+i.height>t.y&&i.x===t.x-t.width))[0]:null,t.neighboor.right=t.x<=this.rows-1?this.cells.filter((i=>i.y<=t.y&&i.y+i.height>t.y&&i.x===t.x+t.width))[0]:null}))}}class n{constructor(t,i,s=1,e=1){this.x=t,this.y=i,this.width=s,this.height=e,this.neighboor={},this.active=!1}toggleActive(t){this.active=t||!this.active}}var l="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAUGVYSWZNTQAqAAAACAACARIAAwAAAAEAAQAAh2kABAAAAAEAAAAmAAAAAAADoAEAAwAAAAEAAQAAoAIABAAAAAEAAAAgoAMABAAAAAEAAAAgAAAAAL5bTO0AAAIwaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIgogICAgICAgICAgICB4bWxuczpleGlmPSJodHRwOi8vbnMuYWRvYmUuY29tL2V4aWYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDxleGlmOkNvbG9yU3BhY2U+MTwvZXhpZjpDb2xvclNwYWNlPgogICAgICAgICA8ZXhpZjpQaXhlbFhEaW1lbnNpb24+MzI8L2V4aWY6UGl4ZWxYRGltZW5zaW9uPgogICAgICAgICA8ZXhpZjpQaXhlbFlEaW1lbnNpb24+MzI8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4K9GTeTwAAAb5JREFUWAntkqFuQkEQRedVgSCgAEWQBIPBIAkOHAokkt/hB5A4kHwCGkP4BFCAw73umXY2y8trmzShVOwkMLs7M/fevfsSEUnd72Xx9jLmT+L/JWA2m/29IY6UbyAdj8eaWfOzc9v/lLPz1m84lu08yB+EjUYjl9QGe71emiSJiiuXy+l8PvdCrQdQamCx5pw9axNo2QS8uSa3Ful2u1IqlcQNiJ3VajU5HA7S6XRkt9tJoVDQ3tvtprler8vxeJTlcinValXopzYYDLTOH3vw1uv1Q6bGuf8IIV4sFuIUKiDF8/ks7XZb9vu9VCoVmUwmXtz9fpfT6SStVgssGY1GMhwOtY4g5i1TN/GsTRT1xO2xSm8CmA0Bzg3DgHS1Wim41QFDvM1ZZi7suVwu0mw2Pdz1etVL6ROwsZvQAYiRA8Ke4Bb9fl/XxWJRM+QE59ZHRux2u/U9CA0DR4nE3Z6P5FcB0XQ6fbA3CwQx70/gtAWz7HMFoD58MxvKy/YEeTUjydZwHA5c9h9haBHvTND4XUBgAWA2whuHtc1m458414Gw+dlr78Czib7CjwKiA9GB6EB0IDoQHYgOvNyBd8ecCZGxvGNgAAAAAElFTkSuQmCC",A="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADAklEQVRYR81WO09yQRAdaHgkBGyESh4VsRGMjaWx8VFBBXSU/h0a6Cix0kqgIZRY2NgYOgkV2oCNSKPmTDJmvOzl7iUm37fNfWR358yZM48AEX3RP1yB/xZANpul5+fnP+UmGAzS5+fnrzuNDESjUXp/f6ezszPq9/t/AmJnZ4fm8znJUy51DUG9Xqd2u21tHPvH4zHvH41GP+eKxSJ7/fj4aLxrDUCpVKK3tzdKp9MM4Pj4mPL5PL9nMhk6OTmhTqdD1WqVhsMhTSYTisfjP5fjf6vV4u+rqytqNpu0yZmNIpSD+oJEIkGLxYIN4H+v16PZbMbfyWSSwd7f3/N3rVbzZHENAC69ublhFvAuC9/aU/mfy+V4f6FQYMMACBCywByAvby82IVAPMMTh8/Pz9lLzYaNMMBKKpXirU9PT7S/v29kwzMEuODj44PC4bCN3V+eC+iDgwN7EeKGvb09Oj09ZcR+PXeivL29Zc1AzDo7NqYhYi0akFTUerClQpi7vr5mFr++1qu+awggnIuLC7YlTNgaxj6kJ9LUq56sASiXy6zq3d1dury8ZOPIfdSAbfQgDAqrTieMDGjU21APIwjhcrnkTBABoyhZA0BZRT5L/iOGq9WKz5vqgb5YhwzvACHFygoANskhYcAmIwAWKxQKsdcCXpwx9RZjCFDDJd5AHolEPL12E6jOImsAWjB+NKALls6Cu7s7en19JRG4ButZCZ1ZYJuKWgfdbtdfLwgEAhzDSqWyVRmW2oGnZJSvNJSyic6G+WCb5RTtYDCg6XRql4bYJQ1k216g9bBpsnItRNJCAUa3Vi82tOe6leuwWIlQhghnFqCzITSblnN4AShoAFngZMM4Eenc9eO9gBIWNBC3MHhOxVoDiCsGUq/aAGOHh4fsNWYAnIP3+PZkQLxwUuZl1EYbpj2/GNDexmIxajQant7aGjZVQZw1zgMPDw90dHTElEkjEUNu07GoHHVDi1T2+9aAGAQrNsqX/RCtTNFyzlcdcBaebcYx02zgBuIb+3zxEHiGomoAAAAASUVORK5CYIIA",c="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACaklEQVRYhe1WvarqQBCe3GthCok2JjbBRlARRFBU8Am0MpWWKfMW9xl8AUsLQUsfwcbCSizVSiu10kY8zHBm2WTjOaeIOc39IOzv7Dd/O1kNAJ7wi/jzm+SI/wq8VMB1XWXuKziOE7rK53x13pM/13Wf8liea7fbT03TqG8YxtPzPLEuy+GabdtiDcfYdxzH10ofvCQ1TfPZbDbFvK7roo8KWJZFiuE4m83Sfln+J60SAtu2YTwek8tOpxOUy2WaT6fTMBgMhCvv9zscj0coFos07vV60O12aZ3luUUkk0nBcb1exXpoHQg7BNvhcAiTyYTGSG5ZFh1mGIayHyHvOZ/PkM/nBcflciGj/gLAv6AC6/VaHJLL5WA6ndI4kUhAJpMhwcfjQVaxZTg/n8+FfKlUonGtVqM9+/2elGGwnOKBTqcDhUIh1KIg2Cuye4NA62ezmXIT+FxFAcyBw+EgyIOCYQQYgjC8Uh7djzmEHlGSEMkZ/X5fEZbBCsJnUgYRRo7A0HA4fB5gqyuVCjQajZcWRAklBD91fVRIhJ0TBzFDyQG0frFY+OLLfXkuKigh8DyPWq50uq6/zPIooCiAZHi1IKZQKCGQydHlu91OEYoSShJqmiYq23dVLgooHmi1WnC73ahYvJscoSiwXC6hWq1SuYQ3Zb4MJQkx9pvNRrwD+JcamwII0zTpMRK8BfwPjxK+EDAhk6P1MqImR/gUkP8B2EfX8xwWplgqIXwWI3xmx/FTEnVAfv2kUikYjUaxVEKfB9Dq1WoF9XqdvLDdbsWrF755/USiQBDogXdkvozQW4Ath+Sd5AAAH8hAa64K9tj9AAAAAElFTkSuQmCC",d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAFBlWElmTU0AKgAAAAgAAgESAAMAAAABAAEAAIdpAAQAAAABAAAAJgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAAC+W0ztAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgpMwidZAAADBUlEQVRYCe2WP0+iQRDGB85ESSBKg9IQS7ExJiaG0tggdlZaUtL4Ge4z8AUsKOy0tLS01cZYWmqlVtC9t7+RZ2/ljyR38bjCSV5md+eZmWdn33eZnJll4Zmb5OeWeZj4/yLQbrf/fUFCUt6B7OjoyDVjHq1rPkuP+guvONJaT/R7wlqtNjGpHBuNRpbL5Zzc8vJy1ul0IlFhCIqNWIxZZ85YBKVFIB9AYWy2s7NjpVLJgoNpbXV11e7v721ra8tubm5saWnJsW9vb67X1tbs4eHBzs7OrFKpGHhs+/v7bueHOfEuLi4+aGysx5eQxN1u1wJDD4jx+fnZNjc37e7uzlZWVuz4+DiSGwwG9vT0ZBsbG8Syw8NDa7VabocQ/tLYRZ6xSGHPhTml8p0QTE4EZ4epkPT8/NyDy04wyMtPGr8U8/LyYuvr6zHc6+urb8qPgIl2AoIgSk4Q5gi72Nvb83GhUHBNcoR14dCQvbq6ihiIpkJFkVzYPS/JHwmJTk5OPpR3NBCJOX+ESkvwZT6RAOzTM5PTJK0jmGRTklEbFScHVY4vYVoizhkB+JmQQELAUUl3nNouLy/jEU+sQAr+6nGswFcnmhb/m8B3BWIF0k9q2gujdX1yfLqz/PQpp7j0k/fPkOuWi0fXoxKhcZz2PX92CaUxGE+73LwC3NlpcpLykGBacoIuLi7OrAA4ZNrN+mN7e/tneN5Rw998Pm/NZtOdIFKv163X69nt7a0/5XLZCS8sLBi+ECXB4+Nj3Ah+1WrVisWiR2WOv3JxNPh4BXROYsE/nM7p4ODAgaoE+vr62qHC9Pt9n7Ou9wNc+o8qf4A0MVQcUoi3TmqVAjALzHyNsezSrE1aT+0h+Jif7GP6s2Bj4EA2tF1ZaL88AX1i2GXsD8GHPsFtoY3Ldnd3Ha84obLZ6elp7A+Hud+bUkCqgjQOIkijyRycAspGgyobjSvEhBFeGh81rcO13wRSEGMl0Lq0CGo+S4/Gkf9wfZzArIB/Yx8l401pCDg3iVfxvBjMncAvw2lIXdl9HdEAAAAASUVORK5CYII=";const p=new t(l),y=new t(l,{rotation:Math.PI}),g=new t(l,{rotation:-Math.PI/2}),m=new t(l,{rotation:Math.PI/2}),u=new t("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABC0lEQVRYR82XuxKFIAxEoaOTX7Tk76Gj8w6Fjo9ANgmO19IEcrJLGPXrum5O+MQYXc5ZuIpO9xqAGZX3Jj4D2Jv4X4BSiluW5aI29a4ltLwW0zwPBfai2g17ED3I6RZI1VAD9OyQ2gABSLuiIHrAEIC0K0n+FACLQgdArdWFECTw0IhyGw4V0HQ2WkPFRBbMOvlnVUQAlJyoSvAU3Dd8o+upCnCHjIubLRgVQOy5ALwtNwXrU0pbuwPQA4Z0xcluOgOcSqP48B6w3oSSrk0KaAv11nWnYLbXYgBrp9xZUX0Vc6pwcXIMv/oxUSmA2oLK3ybv1asYAT4ANP4hBc455g+Se0FU6hHo5xb8AJfrvEk3ziJWAAAAAElFTkSuQmCC"),b=new t(d),w=new t(d,{rotation:Math.PI/2}),f=new t(A),I=new t(A,{rotation:Math.PI}),v=new t(A,{rotation:Math.PI/2}),E=new t(A,{rotation:-Math.PI/2}),C=new t(c),x=new t(c,{rotation:Math.PI/2}),S=new t(c,{rotation:-Math.PI/2}),B=new t(c,{rotation:Math.PI}),T=new t("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACnElEQVRYhe1Wu6oiQRAt3UCNFIOZiQYTQUR8BCKCiRiZmpkIE/oX+yeCPyEIIn6Bj0AMxUgNfICggjhL9VJDa1ePyrL3JvdA0zNd3X1OVb8qAAAufCOC30mO+BGgFeA4jtLmh0ajwVrfmcf1K47jePZAICDqaDTqttttzy73QZtt28pYXdFGAGGaJsznc8jlcuI/HA6L+ng8itqyLFgsFtDpdMAwDNEfbbVaTZnLLxoP6p5V038sFnvwlqs5O5ZsNquNAHsPoNL1eg29Xk98o4dUy3aMAHocjUYf+pCncp/9fg/D4VDxnhWgE4JYLpeQSCQ8YgK2cwSIVqsF3W5XadcKqFQqkEwmWa9kYHuz2fT2BgcUheJ0YDfharVSws4B7dfrlbH8BY6tVqsQj8chGGSp9AKy2SwcDgfWc5mAcLlcFDtht9vB/X5X2hHKEpDXmUwGisWiNvzvgkTati0ceylAFgE+Z/dfxMhgl4CIPyUnApkIv8fjMUuOYCOAyOfzMJlMPBGvTsQnAl8K+B9h152oXwDw+7kRd+1oNBIRKBQKyqBPyJH4drtBv98X3zinDHYP0G7VqaYjh7chZ5fJ8SjTHcD1ZQXgALw8dJBvPr/lQsJYLAaz2UwcQw6sALw0cBnwGvUjCIVCrFeyOIqETgC7CeHFA4LXKz5IBHqY6KEi7+v1ungN/USyEUCC0+kklOMk8p2ANb16lJicz2dRY7tMRuQ0hw5KkvCcRMhJBpd0PNsxefFLbp7KexkR1aZpuoZhiO9yuexaluXlh1gikYioc7mcWyqVRH+G1CvKEujWazAYiHXebDaw3W5FSFOplEhYEJSc0BGdTqeQTqdF/1dQVOmiQaXRaChtfkU3jzYn/EooS/Aj4EsBAH8A6Nf8/nuxSYAAAAAASUVORK5CYII=");new t("/assets/player_body.7e35df12.png"),new t("/assets/player_head.2b71bf7b.png",{offset:new i(-7,0)}),new t("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAFCAYAAACaTbYsAAAARElEQVQYlWP8//8/A0Mw/38GQmDtR0Z0FSxgjWkEtaJaADWI8X8QH0SzQi5ujQ8mI9izkG3GpgAbQNKEsJlcPzMwMAAAkpAZ14XtTasAAAAASUVORK5CYII=",{scale:new i(2,2)});let R={UP:p,DOWN:y,LEFT:g,RIGHT:m,MIDDLE:u,HPIPE:b,VPIPE:w,TOP_END:f,BOTTOM_END:I,RIGHT_END:v,LEFT_END:E,UP_LEFT:C,UP_RIGHT:x,DOWN_LEFT:S,DOWN_RIGHT:B,CUBE:T};class P extends n{constructor(t,i,s){super(t,i,1,1),this.parent=s;let e=this.parent.map.grid.getCell(this.x,this.y);this.neighboor=e.neighboor}defineTexture(){let t=this.neighboor,i=["up","down","right","left","middle"];switch(t.top&&t.top.active&&(i=i.filter((t=>!t.includes("up")))),t.bottom&&t.bottom.active&&(i=i.filter((t=>!t.includes("down")))),t.right&&t.right.active&&(i=i.filter((t=>!t.includes("right")))),t.left&&t.left.active&&(i=i.filter((t=>!t.includes("left")))),1===i.length?this.side="MIDDLE":(i=i.filter((t=>!t.includes("middle"))),this.side=i.join("-").toUpperCase()),this.side){case"UP":this.texture=R.UP;break;case"DOWN":this.texture=R.DOWN;break;case"LEFT":this.texture=R.LEFT;break;case"RIGHT":this.texture=R.RIGHT;break;case"MIDDLE":this.texture=R.MIDDLE;break;case"UP-DOWN":this.texture=R.HPIPE;break;case"RIGHT-LEFT":this.texture=R.VPIPE;break;case"UP-DOWN-LEFT":this.texture=R.LEFT_END;break;case"UP-DOWN-RIGHT":this.texture=R.RIGHT_END;break;case"UP-RIGHT-LEFT":this.texture=R.TOP_END;break;case"DOWN-RIGHT-LEFT":this.texture=R.BOTTOM_END;break;case"UP-DOWN-RIGHT-LEFT":this.texture=R.CUBE;break;case"UP-LEFT":this.texture=R.UP_LEFT;break;case"UP-RIGHT":this.texture=R.UP_RIGHT;break;case"DOWN-LEFT":this.texture=R.DOWN_LEFT;break;case"DOWN-RIGHT":this.texture=R.DOWN_RIGHT}this.texture||console.log(this.side)}}class G{constructor(t,e,h,o,a,r,n,l){switch(this.type=e,this.map=t,this.isStatic=l.isStatic,this.env=n,this.width=a*this.env.relToAbs,this.height=r*this.env.relToAbs,this.tiles=[],this.pos=new i(h*this.env.relToAbs,o*this.env.relToAbs),this.type){case"rect":this.body=s.Bodies.rectangle(this.pos.x,this.pos.y,this.width,this.height,Object.assign({isStatic:this.isStatic},l));for(let t=0;t<a;t++)for(let i=0;i<r;i++){let s=this.map.grid.getCell(h+t,o+i);s.toggleActive(!0),this.tiles.push(new P(s.x,s.y,this))}this.id=this.body.id;break;case"circle":this.body=s.Bodies.circle(this.pos.x,this.pos.y,(this.width+this.height)/2,Object.assign({isStatic:this.isStatic},l)),this.id=this.body.id}this.env.objects.push(this),s.World.add(this.env.world,this.body)}render(){this.tiles.forEach((t=>{e.rect(t.x*this.env.relToAbs-this.env.camera.x,t.y*this.env.relToAbs-this.env.camera.y,t.width*this.env.relToAbs,t.height*this.env.relToAbs,{lineWidth:1})}))}update(){}}const k={collision:{collisionCategory:{body:16,arm:17,shot:16,wall:16},collisionGroup:{body:1,arm:2,shot:1,wall:1},collisionMask:{body:65537,arm:65537,wall:65537,shot:65537}},gravity:{scale:.00195}},W=k.collision;var F=0;class O{constructor(t,i,e,h,o,a,r){this.id=1e3+F,F++,this.x=t,this.y=i,this.dir=e,this.damage=h,this.speed=o,this.size=a,this.weapon=r,this.player=this.weapon.player,this.env=this.player.env,this.body=s.Bodies.rectangle(this.x,this.y,this.size*this.env.relToAbs/3,6,{label:"Shot",id:this.id,friction:0,angle:this.dir,collisionFilter:{group:W.collisionGroup.shot,category:W.collisionCategory.shot,mask:W.collisionMask.shot}}),s.Body.setInertia(this.body,1/0),this.env.addShot(this)}update(){let t=this.env.timescale;const i=this.speed*t;s.Body.translate(this.body,{x:Math.cos(this.dir)*i,y:Math.sin(this.dir)*i}),this.x=this.body.position.x,this.y=this.body.position.y,(this.x>this.env.mapWidth||this.x<-500||this.y>this.env.mapHeight||this.y<0)&&this.destroy()}destroy(){this.env.shots=this.env.shots.filter((t=>t.id!==this.id)),s.World.remove(this.env.world,this.body)}}class Z extends class{constructor(t){this.player=t,this.name="Unknown",this.fireRange=1/0,this.fireRate=5,this.spread=Math.PI/20,this.nbShoot=1,this.shootSpeed=30,this.shootDamage=20,this.maxAmmo=20,this.ammoSize=2,this.reloadTime=1e3,this.nbAmmo=this.maxAmmo,this.isReloading=!1,this.canShoot=!0,this.autofire=!1}shoot(t=!1){if(this.isReloading||!this.canShoot)return;if(t&&!this.autofire)return;if(0==this.nbAmmo)return this.reload(),null;let{x:i,y:e}=this.player.playerArm.vertices[2];this.recoil=this.shootDamage*this.nbShoot/175,s.Body.applyForce(this.player.body,this.player.pos,{x:-this.recoil*Math.cos(this.player.angle),y:-this.recoil*Math.sin(this.player.angle)});const o=new O(i,e,this.player.angle,this.shootDamage,this.shootSpeed,this.ammoSize,this);return this.nbAmmo-=1,this.canShoot=!1,new h(1e3/this.fireRate,(()=>{this.canShoot=!0})),t||(this.autofire=!0),this.autofire&&new h(1e3/this.fireRate,(()=>this.shoot(!0))),o}stopShoot(){this.autofire=!1}singleShoot(){this.shoot(),this.stopShoot()}reload(){this.isReloading=!0,new h(this.reloadTime,(()=>{this.nbAmmo=this.maxAmmo,this.isReloading=!1}))}}{constructor(t){super(t),this.name="AR",this.fireRange=1/0,this.fireRate=5,this.spread=Math.PI/20,this.nbShoot=1,this.shootSpeed=30,this.shootDamage=20,this.maxAmmo=10,this.ammoSize=2,this.reloadTime=800}}class L{constructor(t,i){this.event=t,this.callback=i,window.addEventListener(this.event,this.callback)}}class M{constructor(t,i){this.delay=t,this.callback=i,window.setTimeout(this.callback,this.delay)}}class D{constructor(t,s){this.id=s.particles.length+1,this.env=s,this.pos=t.clone(),this.angle=Math.PI/2+Math.random()*Math.PI,this.velocity=new i(5*Math.random()*Math.cos(this.angle),5*Math.random()*Math.sin(this.angle)),this.color="red",this.opacity=255*Math.random(),this.radius=3,this.env.particles.push(this)}update(){this.velocity.y+=1,this.pos.x+=this.velocity.x*this.env.timescale,this.pos.y+=this.velocity.y*this.env.timescale}render(){e.circle(this.pos.x,this.pos.y,this.radius)}}class N{constructor(t,i,s,e){this.pos=i,this.lifeDuration=s,this.particles=[],this.env=e;for(let h=0;h<t;h++){let t=new D(this.pos,this.env);this.particles.push(t)}new h(this.lifeDuration*this.env.timescale,(()=>this.destroy()))}destroy(){const t=this.particles.map((t=>t.id));this.env.particles=this.env.particles.filter((i=>!t.includes(i.id)))}}var U={player_name:"Player 1",keybind:{move_forward:["D","RIGHT"],move_backward:["Q","LEFT"],jump:["Z","SPACE","UP"],crouch:["S","DOWN"],dash:"SHIFT",reload:"R"}};const j={ZERO:o.ZERO,ONE:o.ONE,TWO:o.TWO,THREE:o.THREE,FOUR:o.FOUR,FIVE:o.FIVE,SIX:o.SIX,SEVEN:o.SEVEN,EIGHT:o.EIGHT,NINE:o.NINE,A:o.A,B:o.B,C:o.C,D:o.D,E:o.E,F:o.F,G:o.G,H:o.H,I:o.I,J:o.J,K:o.K,L:o.L,M:o.M,N:o.N,O:o.O,P:o.P,Q:o.Q,R:o.R,S:o.S,T:o.T,U:o.U,V:o.V,W:o.W,X:o.X,Y:o.Y,Z:o.Z,ENTER:o.ENTER,SHIFT:o.SHIFT,ESC:o.ESC,SPACE:o.SPACE,LEFT:o.LEFT,UP:o.UP,RIGHT:o.RIGHT,DOWN:o.DOWN,BACKSPACE:o.BACKSPACE,DELETE:o.DELETE,TAB:o.TAB,TILDE:o.TILDE2},Y=k.collision;class H{constructor(t,e,h,o,a){this.name=t,this.pos=e,this.width=h,this.height=o,this.env=a,this.id=this.env.entities.length+1,this.velocity=new i(0,0),this.health=100,this.alive=this.health>0,this.groundForce=.04,this.airForce=.01,this.mass=5,this.jumpForce=.3,this.stoppingFriction=.7,this.onAir=!1,this.isMoving=!1,this.isCrouch=!1,this.createBody(),this.dir=this.env.cursorPosition.x>this.body.position.x?"left":"right",s.Body.setMass(this.body,this.mass)}createBody(){const t=1*this.height/3,i=2*this.height/3,e=1*this.height/3;this.crouchOffset=parseFloat((1.5*this.height/6).toFixed(2)),this.playerHead=s.Bodies.circle(this.pos.x,this.pos.y-t,this.width/2,{label:"PlayerCircle"}),this.playerBody=s.Bodies.rectangle(this.pos.x,this.pos.y,this.width,i/2,{label:"PlayerRect"}),this.insideLegs=s.Bodies.rectangle(this.pos.x,this.pos.y+e,this.width,i/2,{label:"PlayerRect"}),this.jumpSensor=s.Bodies.rectangle(this.pos.x,this.pos.y+this.height/2,this.width,4,{sleepThreshold:9e10,label:"PlayerRect",isSensor:!0}),this.playerLegs=s.Body.create({parts:[this.insideLegs,this.jumpSensor],label:"ComposedBody",restitution:.2}),this.playerArm=s.Bodies.rectangle(this.pos.x+this.width-5,this.playerBody.position.y,2*this.width/3,10,{label:"PlayerRect",inertia:1/0,sleepThreshold:1/0,collisionFilter:{group:Y.collisionGroup.arm,category:Y.collisionCategory.arm,mask:Y.collisionMask.arm}});let h=[this.playerBody,this.playerHead,this.playerLegs,this.jumpSensor];this.idArray=h.concat([this.playerArm]).map((t=>t.id)),this.body=s.Body.create({parts:[this.playerBody,this.playerHead,this.playerLegs,this.jumpSensor],inertia:1/0,friction:.01,frictionAir:.01,frictionStatic:.25,restitution:.14,sleepThreshold:1/0,collisionFilter:{group:Y.collisionGroup.body,category:Y.collisionCategory.body,mask:Y.collisionMask.body}}),console.log(this.body),this.armConstraint=s.Constraint.create({bodyA:this.body,pointA:{x:this.width/2-5,y:0},bodyB:this.playerArm,pointB:{x:-this.width/2,y:0},stiffness:1,length:0}),this.composite=s.Composite.create({label:"Player",bodies:[this.body,this.playerArm],constraints:[this.armConstraint]})}flipDirection(){this.dir="left"===this.dir?"right":"left";const t="left"===this.dir?1:-1;s.Composite.remove(this.composite,this.armConstraint),s.Body.setAngle(this.playerArm,0),this.armConstraint=s.Constraint.create({bodyA:this.body,pointA:{x:t*this.width/2-5*t,y:0},bodyB:this.playerArm,pointB:{x:-this.width/2,y:0},stiffness:1,length:0}),s.Composite.add(this.composite,this.armConstraint),s.Body.setAngle(this.playerArm,this.angle),s.Body.setInertia(this.body,1/0),s.Body.setInertia(this.playerArm,1/0)}distTo(t){const i=this.pos.x-t.pos.x,s=this.pos.y-t.pos.y;return Math.sqrt(i**2+s**2)}getCloserPlayer(){return this.env.entities.sort(((t,i)=>this.distTo(t)-this.distTo(i)))[1]}hitBy(t,i){this.health-=t.damage,this.health<0&&(this.health=0),this.env.removeShot(t),new N(5,this.body.position,200,this.env)}checkDeath(){this.alive=!(this.health<=0||this.pos.y>this.env.mapHeight),this.alive||console.log(`${this.name} vient de mourir`)}render(){this.composite.bodies.forEach((t=>{!function(t,i,s){const h=s.map((s=>new a(t+s.x,i+s.y)));e.poly(h)}(this.pos.x,this.pos.y,t.vertices)}))}update(){this.alive&&(this.onAir=!1,this.isMoving&&!(this.body.speed>12)||this.onAir?this.isMoving=!1:s.Body.setVelocity(this.body,{x:this.body.velocity.x*this.stoppingFriction,y:this.body.velocity.y*this.stoppingFriction}),this.pos=new i(this.body.position.x,this.body.position.y),this.checkDeath())}}class z extends H{constructor(t,s,e,h,o,a,r=!1){super(t,new i(s+h/2,e+o/2),h,o,a),this.cameraFocus=!1,this.cameraFocus=r,this.nbJump=0,this.wallSlide=!1,this.wallSlideSide="no-collision",this.weapon=new Z(this),this.env.events.push(new L("mousedown",(()=>this.weapon.shoot()))),this.env.events.push(new L("mouseup",(()=>this.weapon.stopShoot()))),this.env.addEntity(this),this.initSetup(U)}initSetup(t){Object.keys(t.keybind).forEach((i=>{let s=t.keybind[i];"string"==typeof s?this.assignKey(i,s):"object"==typeof s&&s.forEach((t=>{this.assignKey(i,t)}))})),o.run((()=>o.tick()))}assignKey(t,i){let s=j[i];switch(t){case"move_forward":s.down((()=>this.move("right")));break;case"move_backward":s.down((()=>this.move("left")));break;case"jump":s.press((()=>this.jump()));break;case"crouch":s.down((()=>this.crouch())),s.up((()=>this.uncrouch()));break;case"dash":s.press((()=>console.log("grappeln")));break;case"reload":s.press((()=>this.weapon.reload()))}o.F.press((()=>this.slowMotion())),o.E.press((()=>this.autoShoot()))}move(t){if(this.body.speed<=12&&"jump"!==this.wallSlideSide){const i="left"===t?-1:1,s=this.onAir?this.airForce:this.groundForce;this.body.force.x=i*s,this.isMoving=!0}}jump(){if(!this.onAir||this.nbJump<2){const t=1===this.nbJump?.8*this.jumpForce:this.jumpForce;let i=0;this.wallSlide&&"no-collision"!==this.wallSlideSide&&(i="left"===this.wallSlideSide?4*-this.groundForce:4*this.groundForce,this.wallSlideSide="jump"),s.Body.applyForce(this.body,this.pos,{x:i,y:.12*t*this.mass}),this.body.force.y=-t,s.Body.setVelocity(this.body,{x:this.body.velocity.x,y:0}),this.nbJump++}}crouch(){this.isCrouch||(s.Body.translate(this.playerLegs,{x:0,y:-this.crouchOffset}),s.Body.set(this.body,"airFriction",.01/3),this.isCrouch=!0)}uncrouch(){this.isCrouch&&(s.Body.translate(this.playerLegs,{x:0,y:this.crouchOffset}),s.Body.set(this.body,"airFriction",.01),this.isCrouch=!1)}autoShoot(){const t=this.getCloserPlayer();t&&(this.lookAt(t.playerHead.position),this.weapon.singleShoot())}slowMotion(){1===this.env.timescale&&(this.env.changeTimeScale(.33),new M(600,(()=>this.env.changeTimeScale(1))))}lookAt(t){this.angle=Math.atan2(t.y-this.pos.y,t.x-this.pos.x);let e=new i(0,0);"right"===this.dir?e={x:this.body.position.x+this.width/2-5,y:this.body.position.y}:"left"===this.dir&&(e={x:this.body.position.x-this.width/2+5,y:this.body.position.y});const h=s.Vector.angle(e,t);s.Vector.angle(this.body.position,t),s.Body.rotate(this.playerArm,h-this.playerArm.angle,e);const o="left"===this.dir?-1:1;Math.cos(this.angle)*o>0&&this.flipDirection()}onGround(){this.nbJump=0}update(){this.alive&&(this.lookAt(this.env.cursorPosition),this.wallSlide=!1,this.onAir||this.onGround(),this.wallSlide?this.nbJump=1:this.wallSlideSide="no-collision",this.isMoving&&!(this.body.speed>12)||this.onAir?this.isMoving=!1:s.Body.setVelocity(this.body,{x:this.body.velocity.x*this.stoppingFriction,y:this.body.velocity.y*this.stoppingFriction}),this.wallSlide&&0==this.body.friction&&console.log("FrictionError"),this.pos=new i(this.body.position.x,this.body.position.y),this.checkDeath())}}class Q{constructor(t,i,s,e,h){this.zoom=1,this.focus=void 0,this.env=h,this.x=t,this.y=i,this.zoom=1,this.width=s/this.zoom,this.height=e/this.zoom,this.safeZoneSize=this.width/5,this.safeZone={x1:this.width/2-this.safeZoneSize/2,x2:this.width/2+this.safeZoneSize/2,y1:this.height,y2:this.height/3},this.follow_x=!0,this.follow_y=!0}setFocus(t){this.focus=t}include(t){return!0}update(){if(this.focus){let t=this.focus.pos.x,i=this.focus.pos.y;if(this.follow_x){let i=0;t<=this.x+this.safeZone.x1?(i=t-this.x-this.safeZone.x1,this.x+=i):t>=this.x+this.safeZone.x2&&(i=t-this.x-this.safeZone.x2,this.x+=i)}if(this.follow_y){let t=0;i<=this.safeZone.y2?(t=i-this.y-this.safeZone.y2,this.y+=t):i>this.y+this.safeZone.y1&&(t=i-this.y-this.safeZone.y1,this.y+=t)}}}}const V=k.gravity.scale;class J{constructor(t,e){this.width=0,this.height=0,this.tick=0,this.timescale=1,this.framerate=60,this.width=t.clientWidth,this.height=t.clientHeight,this.map=e,this.engine=s.Engine.create({enableSleeping:!0}),this.engineRunner=s.Runner.create({}),this.world=this.engine.world,this.world.gravity.scale=0,this.entities=[],this.shots=[],this.objects=[],this.particles=[],this.events=[],this.cursorPosition=new i(0,0),this.camera=new Q(0,0,this.width,this.height,this),this.relToAbs=Math.min(this.camera.width/e.tileWidth,this.camera.height/e.tileWidth),this.mapWidth=this.map.dimensions.width*this.relToAbs,this.mapHeight=this.map.dimensions.height*this.relToAbs,this.events.push(new L("mousemove",(t=>this.updateCursorPosition(t)))),this.initMatterEngine(),this.initMap()}initMatterEngine(){this.world.gravity.scale=.0019,s.Events.on(this.engine,"beforeUpdate",(t=>{s.Composite.allBodies(this.engine.world).forEach((t=>{t.isStatic||t.isSleeping||"Shot"===t.label||(t.force.y+=t.mass*V)}))})),s.Events.on(this.engine,"collisionStart",(t=>{const i=t.pairs.filter((t=>"Shot"===t.bodyA.label||"Shot"===t.bodyB.label));if(i.length>0)for(let s of i){const t="Shot"===s.bodyA.label?s.bodyA:s.bodyB,i=t===s.bodyA?s.bodyB:s.bodyA;if("Wall"===i.label){const i=this.shots.filter((i=>i.id===t.id))[0];i&&i.destroy()}else"PlayerRect"!=i.label&&"PlayerCircle"!=i.label||this.collision(t,i)}}))}initMap(){this.objects=[],s.World.clear(this.world,!1),this.map.init(this),this.objects.forEach((t=>{t.tiles.forEach((t=>{t.defineTexture()}))}))}addEntity(t){this.entities.push(t),s.World.add(this.world,t.composite),t instanceof z&&t.cameraFocus&&this.camera.setFocus(t)}addShot(t){this.shots.push(t),s.World.add(this.world,t.body)}removeShot(t){this.shots=this.shots.filter((i=>i.id===t.id)),s.World.remove(this.world,t.body)}collision(t,i){const s=this.shots.filter((i=>i.id===t.id))[0];if(s&&s.player.idArray.includes(i.id))return!1;const e=this.entities.filter((t=>t.idArray.includes(i.id)))[0];return e&&s&&e.hitBy(s,i),null!=e}changeTimeScale(t){this.timescale=t,this.engine.timing.timeScale=this.timescale}updateCursorPosition(t){this.cursorPosition=new i(t.clientX+this.camera.x,t.clientY+this.camera.y)}update(){s.Runner.tick(this.engineRunner,this.engine,1/this.framerate),this.objects.forEach((t=>t.update())),this.shots.forEach((t=>t.update())),this.particles.forEach((t=>t.update())),this.entities.forEach((t=>t.update())),this.camera.update(),this.render(),this.tick++,requestAnimationFrame((()=>this.update()))}render(){console.log(e),e.setOffset(-this.camera.x,-this.camera.y),e.beginFrame(),e.rectFromPoints(this.camera.safeZone.x1,this.camera.safeZone.y1,this.camera.safeZone.x2,this.camera.safeZone.y2,{lineWidth:1}),this.objects.forEach((t=>t.render())),this.shots.forEach((t=>{const i=t.body.position,s=t.body.vertices.map((t=>new a(i.x+t.x,i.y+t.y)));e.poly(s)})),this.particles.forEach((t=>t.render())),this.entities.forEach((t=>t.render())),e.endFrame()}}const X=k.collision;class K extends H{constructor(t,s,e,h,o,a){super(t,new i(s+h/2,e+o/2),h,o,a),this.env.addEntity(this)}}var q={name:"Map 1",dimensions:{width:"100",height:"25"},grid:{width:"36",height:"18"},objects:["format type       x     y     w    h    inertie     name","       rect       0    17    90    2     static     floor","       rect       2    10     2    1     static     plateform-1","       rect      22    10     1    1     static     plateform-2","       rect      12     3     1   11     static     vertical-2","       rect      18     3     1   11     static     vertical-1","       rect       6     3     6    1     static     horizontal-1","       rect      19     3     6    1     static     horizontal-2","       rect       0    15     1    2     static     left-block","       rect      29    15     1    2     static     right-block","       rect      40    10     2    1     static     plateform-3","       rect      44     8     3    1     static     plateform-4","       rect      52     4     1   10     static     vertical-3","       rect      56     4     1   10     static     vertical-4"]};const _=e.create(),$=new class{constructor(t){this.file=t,this.tileWidth=Math.min(parseInt(this.file.grid.width),parseInt(this.file.grid.height)),this.objects=this.file.objects,this.dimensions={width:parseInt(this.file.dimensions.width),height:parseInt(this.file.dimensions.height)},this.grid=new r(this.dimensions.height,this.dimensions.width)}init(t){for(let i of this.objects){let[s,e,h,o,a,...r]=i.trimLeft().split(/\s+/);if("format"!=s){let[i,n,l,A]=[parseInt(e),parseInt(h),parseInt(o),parseInt(a)],c={label:"Wall",friction:1e-4,chamfer:{radius:0},mass:5,isStatic:r.includes("static"),frictionStatic:.1,collisionFilter:{group:X.collisionGroup.wall,category:X.collisionCategory.wall,mask:X.collisionMask.wall}};new G(this,s,i,n,l,A,t,c)}}this.grid.defineNeighboors()}}(q);window.onload=()=>{let t=new J(_,$),i=new z("Dorian",300,200,50,80,t,!0),s=new K("Bad Guy",200,200,40,88,t);new K("Bad Guy 2 ",2200,200,40,88,t),window.env=t,window.player=i,window.enemy1=s,t.update(),_.focus()};
